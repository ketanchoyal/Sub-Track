import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter_rounded_date_picker/flutter_rounded_date_picker.dart';
import 'package:flutter_svg/svg.dart';
import 'package:keyboard_actions/external/keyboard_avoider/bottom_area_avoider.dart';
import 'package:keyboard_actions/keyboard_actions.dart';
import 'package:keyboard_actions/keyboard_custom.dart';
import 'package:modal_bottom_sheet/modal_bottom_sheet.dart';
import 'package:stacked/stacked.dart';
import 'package:stacked/stacked_annotations.dart';
import 'package:sub_track/core/models/brands.dart';
import 'package:sub_track/ui/dumb_widgets/text_fields.dart';
import 'package:sub_track/ui/dumb_widgets/textfield_outline.dart';
import 'package:sub_track/ui/resources/resources.dart';

import 'package:sub_track/ui/theme/app_colors.dart';
import 'package:sub_track/ui/view/add_sub_details/add_sub_details_view.form.dart';
import 'package:sub_track/ui/view/add_sub_details/widgets/color_picker.dart';
import 'package:sub_track/ui/view/add_sub_details/widgets/detail_form_element.dart';
import './add_sub_details_viewmodel.dart';
import 'package:sub_track/ui/shared/shared.dart';

// @FormView(fields: [
//   FormTextField(name: 'name'),
//   FormTextField(name: 'cost'),
//   FormTextField(name: 'description'),
//   FormTextField(name: 'sharedWith'),
// ])
class AddSubDetailsView extends StatelessWidget with $AddSubDetailsView {
  final Brand brand;

  AddSubDetailsView({Key? key, required this.brand}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ViewModelBuilder<AddSubDetailsViewModel>.reactive(
      viewModelBuilder: () => AddSubDetailsViewModel(),
      onModelReady: (model) {
        listenToFormUpdated(model);
        model.setBrand(brand);
      },
      builder: (context, model, child) {
        return CupertinoPageScaffold(
          resizeToAvoidBottomInset: false,
          navigationBar: CupertinoNavigationBar(
            automaticallyImplyLeading: false,
            transitionBetweenRoutes: true,
            middle: Text(
              brand.title,
              style: kNavigationStyle,
            ),
            leading: Padding(
              padding:
                  const EdgeInsetsDirectional.only(start: 0, end: 0, top: 7),
              child: GestureDetector(
                onTap: () {
                  model.pop();
                },
                child: Text.rich(
                  TextSpan(
                    text: String.fromCharCode(CupertinoIcons.back.codePoint),
                    style: TextStyle(
                      inherit: false,
                      color: CupertinoTheme.of(context).primaryColor,
                      fontSize: 30.0,
                      fontFamily: CupertinoIcons.back.fontFamily,
                      package: CupertinoIcons.back.fontPackage,
                    ),
                  ),
                ),
              ),
            ),
            trailing: GestureDetector(
              onTap: () {},
              child: Icon(
                CupertinoIcons.plus,
                size: 30,
              ),
            ),
          ),
          child: KeyboardActions(
            tapOutsideToDismiss: true,
            disableScroll: true,
            config: KeyboardActionsConfig(
              keyboardActionsPlatform: KeyboardActionsPlatform.ALL,
              keyboardBarColor: Colors.grey[200],
              nextFocus: false,
              actions: [
                KeyboardActionsItem(
                  focusNode: colorFocusNode,
                  displayDoneButton: true,
                  footerBuilder: (_) => ColorPickerKeyboard(
                    notifier: model.colorChangeNotifier,
                  ),
                ),
              ],
            ),
            child: ListView(
              children: [
                CupertinoFormSection.insetGrouped(
                  margin: EdgeInsets.all(8),
                  header: Center(
                    child: Padding(
                      padding: const EdgeInsets.all(10.0),
                      child: SvgPicture.network(
                        brand.iconUrl,
                        height: 90,
                        color: brand.hex.toColor() ?? AppColor.STAccent,
                        fit: BoxFit.fitHeight,
                      ),
                    ),
                  ),
                  children: [
                    STTextFieldOutline(
                      enableDecoration: false,
                      child: STTextField(
                        controller: nameController,
                        focusNode: nameFocusNode,
                        textInputAction: TextInputAction.next,
                        nextFocusNode: costFocusNode,
                        type: TextFieldType.DEFAULT,
                      ),
                      title: "Name",
                    ),
                    STTextFieldOutline(
                      enableDecoration: false,
                      child: STTextField(
                        controller: costController,
                        focusNode: costFocusNode,
                        textInputAction: TextInputAction.next,
                        nextFocusNode: descriptionFocusNode,
                        type: TextFieldType.DEFAULT,
                      ),
                      title: "Cost",
                    ),
                    STTextFieldOutline(
                      enableDecoration: false,
                      child: STTextField(
                        controller: descriptionController,
                        textInputAction: TextInputAction.done,
                        focusNode: descriptionFocusNode,
                        type: TextFieldType.DEFAULT,
                        onSubmitted: (_) => model.saveData(),
                      ),
                      title: "Description",
                    ),
                  ],
                ),
                if (model.isExpanded)
                  CupertinoFormSection.insetGrouped(
                    margin: EdgeInsets.all(8),
                    children: [
                      CupertinoFormRow(
                        padding: EdgeInsets.zero,
                        child: Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            Flexible(
                              child: STTextFieldOutline(
                                title: "Icon",
                                child: STDetailFormElement(
                                  onTap: () {
                                    model.navigateToSelectIcon();
                                  },
                                  child: Image.asset(
                                    AppIconsAssets.google,
                                    height: 40,
                                  ),
                                ),
                              ),
                            ),
                            Flexible(
                              child: STTextFieldOutline(
                                title: "Color",
                                child: KeyboardCustomInput<Color>(
                                  focusNode: colorFocusNode,
                                  notifier: model.colorChangeNotifier,
                                  builder: (context, val, hasFocus) {
                                    return STDetailFormElement(
                                      child: CircleAvatar(
                                        backgroundColor: val,
                                      ),
                                    );
                                  },
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      STTextFieldOutline(
                        title: "Category",
                        child: STDetailFormElement(
                          onTap: model.navigateToSelectCategory,
                          child: Text(
                            "None",
                            style: kBodyBoldStyle.copyWith(
                              color: AppColor.STDark,
                            ),
                          ),
                        ),
                      ),
                      STTextFieldOutline(
                        title: "Sub Started On",
                        child: STDetailFormElement(
                          onTap: () async {
                            await CupertinoRoundedDatePicker.show(
                              context,
                              onDateTimeChanged: model.setDate,
                              background:
                                  CupertinoTheme.of(context).barBackgroundColor,
                              fontFamily: CupertinoTheme.of(context)
                                  .textTheme
                                  .textStyle
                                  .fontFamily,
                            );
                          },
                          child: Text(
                            model.date,
                            style: kBodyBoldStyle.copyWith(
                              color: AppColor.STDark,
                            ),
                          ),
                        ),
                      ),
                      STTextFieldOutline(
                        title: "Renews Every",
                        child: STDetailFormElement(
                          onTap: () => model.navigateToOtherSelectView(
                              type: OtherDetailSelectType.Renews_Every),
                          child: Text(
                            "Week",
                            style: kBodyBoldStyle.copyWith(
                              color: AppColor.STDark,
                            ),
                          ),
                        ),
                      ),
                      STTextFieldOutline(
                        title: "Notification",
                        child: STDetailFormElement(
                          onTap: () => model.navigateToOtherSelectView(
                              type: OtherDetailSelectType.Notification),
                          child: Text(
                            "Same Day",
                            style: kBodyBoldStyle.copyWith(
                              color: AppColor.STDark,
                            ),
                          ),
                        ),
                      ),
                      STTextFieldOutline(
                        title: "Shared With",
                        child: STTextField(
                          textInputType: TextInputType.numberWithOptions(
                              signed: false, decimal: false),
                          focusNode: sharedWithFocusNode,
                          textInputAction: TextInputAction.done,
                          type: TextFieldType.DEFAULT,
                        ),
                      ),
                    ],
                  ),
                CupertinoFormSection.insetGrouped(
                  margin: EdgeInsets.all(8),
                  children: [
                    CupertinoButton(
                      onPressed: model.toggleIsExpanded,
                      child: Row(
                        children: [
                          Padding(
                            padding: const EdgeInsets.symmetric(
                              horizontal: 5,
                              // vertical: 15,
                            ),
                            child: Text(
                              model.isExpanded ? "Basic" : "Advanced",
                              style: kBodyLargeStyle.copyWith(
                                fontWeight: FontWeightX.bold,
                                color: AppColor.STFailure,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                )
              ],
            ),
          ),
        );
      },
    );
  }
}

/// A quick example "keyboard" widget for picking a color.
