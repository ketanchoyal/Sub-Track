import 'package:stacked/stacked.dart';
import 'package:sub_track/app/app.locatorx.dart';
import 'package:sub_track/core/models/subscription/subscription.dart';
import 'package:sub_track/core/repository/subscription/subscription_repo.dart';
import 'package:sub_track/core/services/url_launch_service.dart';
import 'package:sub_track/ui/shared/mixins.dart';

class ActiveSubscriptionViewModel extends BaseViewModel with $SharedVariables {
  bool isDialogPopped = false;
  double scale = 1.0;
  SubscriptionRepo get _subscriptionRepo => locator<SubscriptionRepo>();
  UrlLaunchService get _urlLaunchService => locator<UrlLaunchService>();
  late Subscription _selectedSub;
  Subscription get selectedSub => _selectedSub;
  Map<String, int?> _remaningDays = {};

  ActiveSubscriptionViewModel() {
    _selectedSub = subscriptions.first;
  }

  selectSub(Subscription sub) async {
    _selectedSub = sub;
    if (_selectedSub.payments == null) {
      setBusy(true);
      await $calculationService.calculateRemainingDays(_selectedSub);
      setBusy(false);
    }
    notifyListeners();
  }

  bool isCurrentSelected(Subscription sub) {
    return sub.subscriptionId == _selectedSub.subscriptionId;
  }

  List<Subscription> get subscriptions =>
      _subscriptionRepo.getSubscriptionsOnce();

  pop() {
    $navigationService.back();
  }

  deleteSub() {
    // _subscriptionRepo.deleteSubscription(
    //     subscriptionId: _selectedSub.subscriptionId);
  }

  DateTime get startedOn {
    return _selectedSub.startedOn;
  }

  int? get remainingDays {
    if (!_remaningDays.containsKey(_selectedSub.subscriptionId)) {
      $calculationService.calculateRemainingDays(_selectedSub).then((value) {
        _remaningDays.addAll({_selectedSub.subscriptionId: value});
        notifyListeners();
      });
      return null;
    }
    return _remaningDays[_selectedSub.subscriptionId];
  }

  openLink() {
    if (_selectedSub.brand.source != null)
      _urlLaunchService.launchUrl(selectedSub.brand.source!);
  }
}
